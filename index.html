<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>L7 é…åˆ—ãƒ„ãƒ¼ãƒ«</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
      max-width: 600px;
      margin: auto;
      box-sizing: border-box;
    }
    table {
      border-collapse: collapse;
      margin: 10px 0;
      width: 100%;
      table-layout: fixed;
    }
    td {
      width: 13vw;
      height: 13vw;
      max-width: 50px;
      max-height: 50px;
      text-align: center;
      border: 1px solid #ccc;
      font-weight: bold;
      font-size: 3.5vw;
      min-font-size: 14px;
    }
    @media (min-width: 601px) {
      td {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
    }

    .white { background-color: #fff; }
    .black { background-color: #999; color: #fff; }
    button {
      margin: 10px 0;
      padding: 10px 15px;
      font-size: 16px;
      display: block;
      width: 100%;
      box-sizing: border-box;
      white-space: normal;
      text-align: center;
    }
    @media (min-width: 601px) {
        .step-section button {
            display: inline-block;
            width: auto;
            margin: 10px 5px;
        }
        .step-section.button-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }
    }

    .step-section {
      margin-bottom: 30px;
      border-bottom: 1px solid #eee;
      padding-bottom: 20px;
    }
    #excludedNumbers {
        margin-top: 10px;
        font-weight: bold;
        color: #d33;
        word-break: break-all;
    }
    #step5And6Container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      flex-wrap: wrap;
    }
    @media (min-width: 601px) {
      #step5And6Container {
        flex-direction: row;
        gap: 40px;
      }
    }
    .step-section > div[style*="margin-top:10px"] {
      word-break: break-all;
    }
  </style>
</head>
<body>

<h2>L7 äºˆæƒ³ãƒã‚§ã‚¹ç›¤é…ç½®ãƒ„ãƒ¼ãƒ«</h2>

<div class="step-section button-group">
  <button onclick="step1And2()">â‘  35å€‹ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—ç”Ÿæˆ & ãƒã‚§ã‚¹ç›¤åˆ†é¡</button>
  <button onclick="resetStorage()">ğŸ”„ å…¨ä½“ãƒªã‚»ãƒƒãƒˆ</button>
  <button onclick="downloadInitialCSV()">â‘¡åˆæœŸçµæœã‚’CSVä¿å­˜</button>
  <div id="step2Container"></div>
  <div id="excludedNumbers"></div>
</div>

<div class="step-section button-group">
  <button onclick="step3()">â‘¢ ä¸¦ã³æ›¿ãˆï¼ˆç™½â†’1-2è¡Œç›®ã€é»’â†’3-4è¡Œç›®ã€æ®‹ã‚Šâ†’5è¡Œç›®ï¼‰</button>
  <button onclick="resetStep3()">ğŸ”„ éƒ¨åˆ†ãƒªã‚»ãƒƒãƒˆ</button>
  <div id="step3Container"></div>
</div>

<div class="step-section button-group">
  <button onclick="step4()">â‘£ ãƒ©ãƒ³ãƒ€ãƒ äº¤æ›</button>
  <div id="step4Container"></div>
  <div style="margin-top:10px; font-size:14px; border-top:1px solid #ccc; padding-top:10px;">
    <strong>ãƒ‘ã‚¿ãƒ¼ãƒ³ä»•æ§˜ä¸€è¦§ï¼š</strong><br>
    â‘ ï¼š1â†”4è¡Œç›®ã€2â†”3è¡Œç›®<br>
    â‘¡ï¼š1â†”3è¡Œç›®ã€2â†”4è¡Œç›®<br>
    â‘¢ï¼š1â†”2è¡Œç›®ã€3â†”4è¡Œç›®<br>
    â‘£ï¼š1ã€œ4è¡Œç›®ã¨5è¡Œç›®ã§ãƒ©ãƒ³ãƒ€ãƒ äº¤æ›
  </div>
</div>

<div class="step-section button-group">
  <button onclick="step5And6()">â‘¤ å„è¡Œã‚’æ˜‡é †ã«ä¸¦ã³æ›¿ãˆã¦æœ€çµ‚çµæœè¡¨ç¤º & æ¯”è¼ƒè¡¨ç¤º</button>
  <button onclick="downloadComparisonCSV()">æ¯”è¼ƒçµæœã‚’CSVä¿å­˜</button>
  <div id="step5And6Container"></div>
</div>

<script>
  let initialGrid = []; // ã‚¹ãƒ†ãƒƒãƒ—1/2ã®ã‚°ãƒªãƒƒãƒ‰ãƒ‡ãƒ¼ã‚¿
  let initialChessColors = []; // ã‚¹ãƒ†ãƒƒãƒ—1/2ã®ãƒã‚§ã‚¹ç›¤è‰²ãƒ‡ãƒ¼ã‚¿
  let currentGrid = []; // ã‚¹ãƒ†ãƒƒãƒ—3ä»¥é™ã§æ“ä½œã•ã‚Œã‚‹ã‚°ãƒªãƒƒãƒ‰ãƒ‡ãƒ¼ã‚¿
  let currentChessColors = []; // ã‚¹ãƒ†ãƒƒãƒ—3ä»¥é™ã§æ“ä½œã•ã‚Œã‚‹ãƒã‚§ã‚¹ç›¤è‰²ãƒ‡ãƒ¼ã‚¿
  let finalGrid = []; // ã‚¹ãƒ†ãƒƒãƒ—5ã®æœ€çµ‚çµæœ
  let excludedNumbers = []; // é¸ã°ã‚Œãªã‹ã£ãŸæ•°å­—

  const rows = 5;
  const cols = 7;

  function generateUniqueNumbers() {
    let nums = Array.from({ length: 37 }, function(_, i) { return i + 1; });
    for (let i = nums.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      var temp = nums[i];
      nums[i] = nums[j];
      nums[j] = temp;
    }
    const selected = nums.slice(0, 35);
    excludedNumbers = nums.slice(35);
    return selected;
  }

  function processStep1() {
    const numbers = generateUniqueNumbers();
    initialGrid = [];
    for (let i = 0; i < rows; i++) {
      const row = numbers.slice(i * cols, (i + 1) * cols);
      initialGrid.push(row);
    }
    // currentGrid ã¯ initialGrid ã®ã‚³ãƒ”ãƒ¼ã‹ã‚‰é–‹å§‹
    currentGrid = JSON.parse(JSON.stringify(initialGrid)); 
    document.getElementById('excludedNumbers').innerHTML = 'é¸ã°ã‚Œãªã‹ã£ãŸæ•°å­—: ' + excludedNumbers.join(', ');
  }

  function processStep2() {
    initialChessColors = [];
    for (let r = 0; r < rows; r++) {
      let row = [];
      for (let c = 0; c < cols; c++) {
        row.push((r + c) % 2 === 0 ? 'white' : 'black');
      }
      initialChessColors.push(row);
    }
    // currentChessColors ã‚‚ initialChessColors ã®ã‚³ãƒ”ãƒ¼ã‹ã‚‰é–‹å§‹
    currentChessColors = JSON.parse(JSON.stringify(initialChessColors));
    document.getElementById('step2Container').innerHTML = ''; // ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰è¡¨ç¤º
    renderGrid(initialGrid, initialChessColors, 'step2Container');
  }

  function step1And2() {
    processStep1(); // ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—ç”Ÿæˆ
    processStep2(); // ãƒã‚§ã‚¹ç›¤åˆ†é¡è¡¨ç¤º
    saveToLocalStorage('step2'); // ã‚¹ãƒ†ãƒƒãƒ—2ã¨ã—ã¦ä¿å­˜
  }

  function step3() {
    // step3å®Ÿè¡Œå‰ã«ã¯å¿…ãšstep2ã®ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
    if (initialGrid.length === 0 || initialChessColors.length === 0) {
        alert("å…ˆã«ã€Œâ‘  35å€‹ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—ç”Ÿæˆ & ãƒã‚§ã‚¹ç›¤åˆ†é¡ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
        return;
    }
    
    // ç¾åœ¨ã®currentGridã¨currentChessColorsã‚’lotto_step3_grid_preã¨ã—ã¦ä¿å­˜ï¼ˆãƒªã‚»ãƒƒãƒˆç”¨ï¼‰
    localStorage.setItem('lotto_step3_grid_pre', JSON.stringify(currentGrid));
    localStorage.setItem('lotto_step3_colors_pre', JSON.stringify(currentChessColors));

    // step3ã®å‡¦ç†ã¯ initialGrid ã¨ initialChessColors ã‚’ãƒ™ãƒ¼ã‚¹ã«è¡Œã†
    const tempGrid = JSON.parse(JSON.stringify(initialGrid));
    const tempChessColors = JSON.parse(JSON.stringify(initialChessColors));

    const whiteOrder = [
      [0, 0], [0, 2], [1, 1], [2, 0], [3, 1], [2, 2], [1, 3],
      [4, 6], [4, 4], [3, 5], [2, 6], [3, 3], [2, 4], [1, 5],
      [4, 0], [4, 2], [0, 4], [0, 6],
    ];

    const blackOrder = [
      [1, 0], [0, 1], [3, 0], [2, 1], [1, 2], [0, 3], [3, 2],
      [4, 5], [3, 6], [4, 3], [3, 4], [2, 5], [1, 6], [0, 5],
      [4, 1], [2, 3], [1, 4],
    ];

    const newWhiteValues = [];
    const newBlackValues = [];
    const newRemainderValues = [];

    const orderedPositions = new Set();

    for (let i = 0; i < whiteOrder.length; i++) {
        const r = whiteOrder[i][0];
        const c = whiteOrder[i][1];
        if (tempChessColors[r][c] === 'white') {
            newWhiteValues.push(tempGrid[r][c]);
            orderedPositions.add(r + ',' + c);
        }
    }

    for (let i = 0; i < blackOrder.length; i++) {
        const r = blackOrder[i][0];
        const c = blackOrder[i][1];
        if (tempChessColors[r][c] === 'black') {
            newBlackValues.push(tempGrid[r][c]);
            orderedPositions.add(r + ',' + c);
        }
    }

    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        if (!orderedPositions.has(r + ',' + c)) {
          newRemainderValues.push(tempGrid[r][c]);
        }
      }
    }

    const whiteGroups = [
      newWhiteValues.slice(0, 7),
      newWhiteValues.slice(7, 14)
    ];
    const blackGroups = [
      newBlackValues.slice(0, 7),
      newBlackValues.slice(7, 14)
    ];
    const remainderGroup = [].concat(newWhiteValues.slice(14), newBlackValues.slice(14), newRemainderValues).slice(0, 7);


    const newGrid = [
      whiteGroups[0],
      whiteGroups[1],
      blackGroups[0],
      blackGroups[1],
      remainderGroup
    ];

    const newColors = [];
    for(let r = 0; r < rows; r++) {
        const rowColors = [];
        for(let c = 0; c < cols; c++) {
            if (r < 2) {
                rowColors.push('white');
            } else if (r < 4) {
                rowColors.push('black');
            } else {
                rowColors.push('');
            }
        }
        newColors.push(rowColors);
    }

    currentGrid = newGrid;
    currentChessColors = newColors;
    document.getElementById('step3Container').innerHTML = '';
    renderGrid(currentGrid, currentChessColors, 'step3Container');
    saveToLocalStorage('step3'); // step3ã¨ã—ã¦ä¿å­˜
    localStorage.setItem('lotto_step3_grid', JSON.stringify(currentGrid)); // ä¸¦ã³æ›¿ãˆå¾Œã®çŠ¶æ…‹ã‚’åˆ¥é€”ä¿å­˜
    localStorage.setItem('lotto_step3_colors', JSON.stringify(currentChessColors)); // ä¸¦ã³æ›¿ãˆå¾Œã®è‰²ã‚’åˆ¥é€”ä¿å­˜
  }

  // ã‚¹ãƒ†ãƒƒãƒ—3ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹æ–°ã—ã„é–¢æ•°
  function resetStep3() {
    // step3Container ã®è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã ã‘
    document.getElementById('step3Container').innerHTML = '';
    
    // step3å®Ÿè¡Œå¾Œã®çŠ¶æ…‹ã‚’ä¿å­˜ã—ãŸlocalStorageã‚’ã‚¯ãƒªã‚¢
    localStorage.removeItem('lotto_step3_grid');
    localStorage.removeItem('lotto_step3_colors');
    
    // `currentGrid` ã¨ `currentChessColors` ã¯ `initialGrid` ã¨ `initialChessColors` ã®çŠ¶æ…‹ã«æˆ»ã‚‹
    // ï¼ˆã“ã“ã§ã¯ç›´æ¥å¤‰æ›´ã›ãšã€æ¬¡å›ã®step3()å®Ÿè¡Œã§å†è¨ˆç®—ã•ã‚Œã‚‹ã‹ã€loadFromLocalStorageã§å¾©å…ƒã•ã‚Œã‚‹ï¼‰
    currentGrid = JSON.parse(JSON.stringify(initialGrid));
    currentChessColors = JSON.parse(JSON.stringify(initialChessColors));

    // ä¿å­˜çŠ¶æ…‹ã‚’ã‚¹ãƒ†ãƒƒãƒ—2ã«æˆ»ã™
    saveToLocalStorage('step2'); 
    // ãƒ­ãƒ¼ãƒ‰ã—ç›´ã—ã¦ã€æ­£ã—ã„çŠ¶æ…‹ã‚’UIã«åæ˜ 
    loadFromLocalStorage();
  }


  function step4() {
    // step4ã¯step3ã®ä¸¦ã³æ›¿ãˆå¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ©ç”¨ã™ã‚‹ã®ã§ã€lotto_step3_grid ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
    const loadedStep3Grid = JSON.parse(localStorage.getItem('lotto_step3_grid'));
    const loadedStep3Colors = JSON.parse(localStorage.getItem('lotto_step3_colors'));

    if (loadedStep3Grid && loadedStep3Colors) {
      currentGrid = JSON.parse(JSON.stringify(loadedStep3Grid));
      currentChessColors = JSON.parse(JSON.stringify(loadedStep3Colors));
    } else {
        alert("ã€Œâ‘¢ ä¸¦ã³æ›¿ãˆã€ã‚¹ãƒ†ãƒƒãƒ—ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    const swapBetween = function(r1, r2) {
      const count = Math.floor(Math.random() * 4);
      const indices = Array.from({ length: cols }, function(_, i) { return i; });
        for (let i = indices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            var temp = indices[i];
            indices[i] = indices[j];
            indices[j] = temp;
        }
      for (let i = 0; i < count; i++) {
        const idx = indices[i];
        var tempGrid = currentGrid[r1][idx];
        currentGrid[r1][idx] = currentGrid[r2][idx];
        currentGrid[r2][idx] = tempGrid;

        var tempColors = currentChessColors[r1][idx];
        currentChessColors[r1][idx] = currentChessColors[r2][idx];
        currentChessColors[r2][idx] = tempColors;
      }
    };

    const swapAcross = function(fromRows, toRow) {
      const fromPositions = [];
      fromRows.forEach(function(r) {
        for (let c = 0; c < cols; c++) {
          fromPositions.push([r, c]);
        }
      });
      const toPositions = [];
      for (let c = 0; c < cols; c++) {
        toPositions.push([toRow, c]);
      }

      const swapCount = Math.floor(Math.random() * 4);
      for (let i = 0; i < swapCount; i++) {
        const fromIdx = Math.floor(Math.random() * fromPositions.length);
        const toIdx = Math.floor(Math.random() * toPositions.length);
        const fromPos = fromPositions.splice(fromIdx, 1)[0];
        const toPos = toPositions.splice(toIdx, 1)[0];
        var r1 = fromPos[0], c1 = fromPos[1];
        var r2 = toPos[0], c2 = toPos[1];

        var tempGrid = currentGrid[r1][c1];
        currentGrid[r1][c1] = currentGrid[r2][c2];
        currentGrid[r2][c2] = tempGrid;

        var tempColors = currentChessColors[r1][c1];
        currentChessColors[r1][c1] = currentChessColors[r2][c2];
        currentChessColors[r2][c2] = tempColors;
      }
    };

    const pattern = Math.floor(Math.random() * 4) + 1;
    let patternMessage = '';

    if (pattern === 1) {
      swapBetween(0, 3);
      swapBetween(1, 2);
      patternMessage = 'ãƒ‘ã‚¿ãƒ¼ãƒ³â‘ ã‚’é©ç”¨ï¼š1â†”4è¡Œç›®ã€2â†”3è¡Œç›®ã‚’ãƒ©ãƒ³ãƒ€ãƒ äº¤æ›';
    } else if (pattern === 2) {
      swapBetween(0, 2);
      swapBetween(1, 3);
      patternMessage = 'ãƒ‘ã‚¿ãƒ¼ãƒ³â‘¡ã‚’é©ç”¨ï¼š1â†”3è¡Œç›®ã€2â†”4è¡Œç›®ã‚’ãƒ©ãƒ³ãƒ€ãƒ äº¤æ›';
    } else if (pattern === 3) {
      swapBetween(0, 1);
      swapBetween(2, 3);
      patternMessage = 'ãƒ‘ã‚¿ãƒ¼ãƒ³â‘¢ã‚’é©ç”¨ï¼š1â†”2è¡Œç›®ã€3â†”4è¡Œç›®ã‚’ãƒ©ãƒ³ãƒ€ãƒ äº¤æ›';
    } else if (pattern === 4) {
      swapAcross([0, 1, 2, 3], 4);
      patternMessage = 'ãƒ‘ã‚¿ãƒ¼ãƒ³â‘£ã‚’é©ç”¨ï¼š1ã€œ4è¡Œç›®ã¨5è¡Œç›®ã§ãƒ©ãƒ³ãƒ€ãƒ äº¤æ›';
    }

    document.getElementById('step4Container').innerHTML = '<p style="font-weight:bold;">' + patternMessage + '</p>';
    renderGrid(currentGrid, currentChessColors, 'step4Container');
    saveToLocalStorage('step4');
  }

  function step5And6() {
    finalGrid = currentGrid.map(function(row) { // currentGridã‚’å…ƒã«æœ€çµ‚çµæœã‚’ç”Ÿæˆ
      return Array.from(row).sort(function(a, b) { return a - b; });
    });

    if (!finalGrid.length || !initialGrid.length) {
      alert("ã€Œâ‘  35å€‹ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—ç”Ÿæˆ & ãƒã‚§ã‚¹ç›¤åˆ†é¡ã€ã¨ã€Œâ‘£ ãƒ©ãƒ³ãƒ€ãƒ äº¤æ›ã€ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ã€ã“ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼");
      return;
    }

    const container = document.getElementById('step5And6Container');
    container.innerHTML = '';

    const sortedInitialGrid = initialGrid.map(function(row) {
      return Array.from(row).sort(function(a, b) { return a - b; });
    });

    const finalTableHTML = renderTitledGrid("æœ€çµ‚çµæœ", finalGrid);
    const initialTableHTML = renderTitledGrid("ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—çµ„åˆã›ï¼ˆè¡Œã‚’æ˜‡é †ï¼‰", sortedInitialGrid);

    container.insertAdjacentHTML('beforeend', finalTableHTML);
    container.insertAdjacentHTML('beforeend', initialTableHTML);

    saveToLocalStorage('step5');
  }

  function renderGrid(g, colors, containerId) {
    let html = '<table>';
    for (let r = 0; r < g.length; r++) {
      html += '<tr>';
      for (let c = 0; c < g[r].length; c++) {
        const color = colors && colors[r] && colors[r][c] ? colors[r][c] : ''; // nullãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
        html += '<td class="' + color + '">' + (g[r][c] || '') + '</td>';
      }
      html += '</tr>';
    }
    html += '</table>';
    document.getElementById(containerId).insertAdjacentHTML('beforeend', html);
  }

  function renderTitledGrid(title, gridData) {
    let html = '<div><div style="font-weight:bold; font-size:18px; margin-bottom:5px;">' + title + '</div><table>';
    for (let r = 0; r < gridData.length; r++) {
      html += '<tr>';
      for (let c = 0; c < gridData[r].length; c++) {
        html += '<td>' + (gridData[r][c] || '') + '</td>';
      }
      html += '</tr>';
    }
    html += '</table></div>';
    return html;
 }

  function getComparisonCSVContent(gridA, gridB) {
    const maxRows = Math.max(gridA.length, gridB.length);
    const lines = [];

    lines.push("æœ€çµ‚çµæœ1,æœ€çµ‚çµæœ2,æœ€çµ‚çµæœ3,æœ€çµ‚çµæœ4,æœ€çµ‚çµæœ5,æœ€çµ‚çµæœ6,æœ€çµ‚çµæœ7,,ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—1,ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—2,ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—3,ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—4,ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—5,ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—6,ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—7");

    for (let i = 0; i < maxRows; i++) {
      const rowA = gridA[i] || [];
      const rowB = gridB[i] || [];
      const paddedA = Array.from(rowA).slice(0, 7);
      while(paddedA.length < 7) paddedA.push('');
      const paddedB = Array.from(rowB).slice(0, 7);
      while(paddedB.length < 7) paddedB.push('');

      lines.push(paddedA.join(',') + ',,' + paddedB.join(','));
    }

    return lines.join('\n');
  }

  function downloadComparisonCSV() {
    if (!initialGrid.length || !finalGrid.length) {
      alert("ã€Œâ‘  35å€‹ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—ç”Ÿæˆ & ãƒã‚§ã‚¹ç›¤åˆ†é¡ã€ã¨ã€Œâ‘¤ å„è¡Œã‚’æ˜‡é †ã«ä¸¦ã³æ›¿ãˆã¦æœ€çµ‚çµæœè¡¨ç¤º & æ¯”è¼ƒè¡¨ç¤ºã€ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼");
      return;
    }

    const sortedInitialGrid = initialGrid.map(function(row) {
      return Array.from(row).sort(function(a, b) { return a - b; });
    });
    const csvContent = getComparisonCSVContent(finalGrid, sortedInitialGrid);
    const bom = '\uFEFF';
    const encodedContent = encodeURIComponent(bom + csvContent);
    
    const now = new Date();
    const filename = 'comparison_result_' + now.toISOString().replace(/[:T.]/g, '-') + '.csv';

    const dataUri = 'data:text/csv;charset=utf-8,' + encodedContent;
    
    const a = document.createElement('a');
    a.href = dataUri;
    a.target = '_blank';
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    setTimeout(function() {
        alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯ã€é–‹ã‹ã‚ŒãŸæ–°ã—ã„ã‚¿ãƒ–ã§ã€Œå…±æœ‰ã€ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆå››è§’ã‹ã‚‰ä¸Šå‘ãã®çŸ¢å°ï¼‰ã‚’ã‚¿ãƒƒãƒ—ã—ã€ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã€ã¾ãŸã¯ã€Œãƒ—ãƒªãƒ³ãƒˆã€ãªã©ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    }, 500);
  }

  function getCSVContent(targetGrid) {
    return targetGrid.map(function(row) { return row.join(','); }).join('\n');
  }

  function downloadInitialCSV() {
    if (!initialGrid.length) {
      alert("ã€Œâ‘  35å€‹ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—ç”Ÿæˆ & ãƒã‚§ã‚¹ç›¤åˆ†é¡ã€ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„ï¼");
      return;
    }
    const csv = getCSVContent(initialGrid);
    const bom = '\uFEFF';
    const encodedContent = encodeURIComponent(bom + csv);

    const now = new Date();
    const filename = 'initial_grid_' + now.toISOString().replace(/[:T.]/g, '-') + '.csv';
    
    const dataUri = 'data:text/csv;charset=utf-8,' + encodedContent;

    const a = document.createElement('a');
    a.href = dataUri;
    a.target = '_blank';
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    setTimeout(function() {
        alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯ã€é–‹ã‹ã‚ŒãŸæ–°ã—ã„ã‚¿ãƒ–ã§ã€Œå…±æœ‰ã€ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆå››è§’ã‹ã‚‰ä¸Šå‘ãã®çŸ¢å°ï¼‰ã‚’ã‚¿ãƒƒãƒ—ã—ã€ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã€ã¾ãŸã¯ã€Œãƒ—ãƒªãƒ³ãƒˆã€ãªã©ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    }, 500);
  }

  // localStorageã¸ã®ä¿å­˜é–¢æ•°
  function saveToLocalStorage(step) {
    localStorage.setItem('lotto_step', step);
    localStorage.setItem('lotto_initial_grid', JSON.stringify(initialGrid));
    localStorage.setItem('lotto_initial_colors', JSON.stringify(initialChessColors));
    localStorage.setItem('lotto_current_grid', JSON.stringify(currentGrid));
    localStorage.setItem('lotto_current_colors', JSON.stringify(currentChessColors));
    localStorage.setItem('lotto_final_grid', JSON.stringify(finalGrid));
    localStorage.setItem('lotto_excluded_numbers', JSON.stringify(excludedNumbers));
  }

  // localStorageã‹ã‚‰ã®ãƒ­ãƒ¼ãƒ‰é–¢æ•°
  function loadFromLocalStorage() {
    try {
      const storedStep = localStorage.getItem('lotto_step');
      initialGrid = JSON.parse(localStorage.getItem('lotto_initial_grid')) || [];
      initialChessColors = JSON.parse(localStorage.getItem('lotto_initial_colors')) || [];
      currentGrid = JSON.parse(localStorage.getItem('lotto_current_grid')) || [];
      currentChessColors = JSON.parse(localStorage.getItem('lotto_current_colors')) || [];
      finalGrid = JSON.parse(localStorage.getItem('lotto_final_grid')) || [];
      excludedNumbers = JSON.parse(localStorage.getItem('lotto_excluded_numbers')) || [];

      // å…¨ã¦ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
      const containers = ['step2Container', 'step3Container', 'step4Container', 'step5And6Container'];
      for (let i = 0; i < containers.length; i++) {
          const containerElement = document.getElementById(containers[i]);
          if (containerElement) {
              containerElement.innerHTML = '';
          }
      }
      document.getElementById('excludedNumbers').innerHTML = '';

      if (initialGrid.length > 0) {
        document.getElementById('excludedNumbers').innerHTML = 'é¸ã°ã‚Œãªã‹ã£ãŸæ•°å­—: ' + excludedNumbers.join(', ');
        renderGrid(initialGrid, initialChessColors, 'step2Container');
      }

      if (storedStep === 'step3' || storedStep === 'step4' || storedStep === 'step5') {
          const loadedStep3Grid = JSON.parse(localStorage.getItem('lotto_step3_grid'));
          const loadedStep3Colors = JSON.parse(localStorage.getItem('lotto_step3_colors'));
          if (loadedStep3Grid && loadedStep3Colors) {
              renderGrid(loadedStep3Grid, loadedStep3Colors, 'step3Container');
          }
      }

      if (storedStep === 'step4' || storedStep === 'step5') {
          renderGrid(currentGrid, currentChessColors, 'step4Container');
      }
      
      if (storedStep === 'step5') {
          const container = document.getElementById('step5And6Container');
          const sortedInitialGrid = initialGrid.map(function(row) {
            return Array.from(row).sort(function(a, b) { return a - b; });
          });
          const finalTableHTML = renderTitledGrid("æœ€çµ‚çµæœ", finalGrid);
          const initialTableHTML = renderTitledGrid("ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—çµ„åˆã›ï¼ˆè¡Œã‚’æ˜‡é †ï¼‰", sortedInitialGrid);
          container.insertAdjacentHTML('beforeend', finalTableHTML);
          container.insertAdjacentHTML('beforeend', initialTableHTML);
      }
    } catch (e) {
      console.error("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯localStorageã‚’ã‚¯ãƒªã‚¢ã—ã¦åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
      resetStorage(); 
    }
  }

  // å…¨ä½“ãƒªã‚»ãƒƒãƒˆé–¢æ•°
  function resetStorage() {
    localStorage.clear();
    initialGrid = [];
    initialChessColors = [];
    currentGrid = [];
    currentChessColors = [];
    finalGrid = [];
    excludedNumbers = [];

    const containers = ['step2Container', 'step3Container', 'step4Container', 'step5And6Container'];
    for (let i = 0; i < containers.length; i++) {
        const containerElement = document.getElementById(containers[i]);
        if (containerElement) {
            containerElement.innerHTML = '';
        }
    }
    document.getElementById('excludedNumbers').innerHTML = '';
    // ãƒ­ãƒ¼ãƒ‰é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦UIã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆ
    loadFromLocalStorage(); 
  }

  window.onload = function () {
    loadFromLocalStorage();
  };
</script>

</body>
</html>