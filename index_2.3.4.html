<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>L7 é…åˆ—ãƒ„ãƒ¼ãƒ«</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 10px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å°‘ã—æ¸›ã‚‰ã™ */
      max-width: 600px; /* PCè¡¨ç¤ºæ™‚ã®æœ€å¤§å¹…ã‚’è¨­å®š */
      margin: auto; /* PCè¡¨ç¤ºæ™‚ã«ä¸­å¤®å¯„ã› */
      box-sizing: border-box; /* paddingãŒwidthã«å«ã¾ã‚Œã‚‹ã‚ˆã†ã« */
    }
    table {
      border-collapse: collapse;
      margin: 10px 0;
      width: 100%; /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¹…ã‚’100%ã«ã™ã‚‹ */
      table-layout: fixed; /* ã‚«ãƒ©ãƒ å¹…ã‚’å›ºå®šã™ã‚‹ï¼ˆtdã®widthãŒåŠ¹ãã‚ˆã†ã«ï¼‰ */
    }
    td {
      width: 13vw; /* ç”»é¢å¹…ã«å¿œã˜ã¦ã‚»ãƒ«ã®å¹…ã‚’èª¿æ•´ */
      height: 13vw; /* ç”»é¢å¹…ã«å¿œã˜ã¦ã‚»ãƒ«ã®é«˜ã•ã‚’èª¿æ•´ */
      max-width: 50px; /* ã‚»ãƒ«ã®æœ€å¤§å¹…ã‚’è¨­å®šï¼ˆå¤§ãããªã‚Šã™ããªã„ã‚ˆã†ã«ï¼‰ */
      max-height: 50px; /* ã‚»ãƒ«ã®æœ€å¤§é«˜ã•ã‚’è¨­å®š */
      text-align: center;
      border: 1px solid #ccc;
      font-weight: bold;
      font-size: 3.5vw; /* ç”»é¢å¹…ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’èª¿æ•´ */
      min-font-size: 14px; /* ãƒ•ã‚©ãƒ³ãƒˆã®æœ€å°ã‚µã‚¤ã‚º */ /* è¿½åŠ : ãƒ•ã‚©ãƒ³ãƒˆãŒå°ã•ããªã‚Šã™ããªã„ã‚ˆã†ã« */
    }
    /* PCè¡¨ç¤ºæ™‚ã«tdã®ã‚µã‚¤ã‚ºã‚’å›ºå®šã™ã‚‹ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª */
    @media (min-width: 601px) {
      td {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
    }

    .white { background-color: #fff; }
    .black { background-color: #999; color: #fff; }
    button {
      margin: 10px 0; /* ä¸Šä¸‹ãƒãƒ¼ã‚¸ãƒ³ã‚’ç¢ºä¿ */
      padding: 10px 15px;
      font-size: 16px;
      display: block; /* ãƒœã‚¿ãƒ³ã‚’ãƒ–ãƒ­ãƒƒã‚¯è¦ç´ ã«ã—ã¦ç¸¦ã«ä¸¦ã¹ã‚‹ */
      width: 100%; /* ãƒœã‚¿ãƒ³ã®å¹…ã‚’100%ã«ã™ã‚‹ */
      box-sizing: border-box; /* paddingãŒwidthã«å«ã¾ã‚Œã‚‹ã‚ˆã†ã« */
      white-space: normal; /* ãƒœã‚¿ãƒ³å†…ã®ãƒ†ã‚­ã‚¹ãƒˆãŒæŠ˜ã‚Šè¿”ã™ã‚ˆã†ã« */
      text-align: center; /* ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸­å¤®æƒãˆ */
    }
    /* PCè¡¨ç¤ºæ™‚ (å¹…ãŒåºƒã„å ´åˆ) ã¯ãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ */
    @media (min-width: 601px) {
        .step-section button {
            display: inline-block; /* ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ–ãƒ­ãƒƒã‚¯ã«æˆ»ã™ */
            width: auto; /* å¹…ã‚’è‡ªå‹•èª¿æ•´ã«æˆ»ã™ */
            margin: 10px 5px; /* å…ƒã®ãƒãƒ¼ã‚¸ãƒ³ */
        }
        /* è¤‡æ•°ã®ãƒœã‚¿ãƒ³ãŒã‚ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒœã‚¿ãƒ³ã¯æ¨ªä¸¦ã³ã§ã€gapã‚’è¨­å®š */
        .step-section.button-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px; /* ãƒœã‚¿ãƒ³é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
        }
    }

    .step-section {
      margin-bottom: 30px;
      border-bottom: 1px solid #eee; /* å„ã‚¹ãƒ†ãƒƒãƒ—ã®åŒºåˆ‡ã‚Š */
      padding-bottom: 20px;
    }
    #excludedNumbers {
        margin-top: 10px;
        font-weight: bold;
        color: #d33;
        word-break: break-all; /* é•·ã„æ•°å­—ãƒªã‚¹ãƒˆãŒã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã« */
    }
    /* æ¯”è¼ƒè¡¨ç¤ºã®ã‚³ãƒ³ãƒ†ãƒŠ */
    #step5And6Container {
      display: flex;
      flex-direction: column; /* ã‚¹ãƒãƒ›ã§ã¯ç¸¦ã«ä¸¦ã¹ã‚‹ */
      gap: 20px; /* å„ãƒ†ãƒ¼ãƒ–ãƒ«é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
      flex-wrap: wrap; /* æŠ˜ã‚Šè¿”ã— */
    }
    /* PCè¡¨ç¤ºæ™‚ã«æ¨ªä¸¦ã³ã«æˆ»ã™ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª */
    @media (min-width: 601px) {
      #step5And6Container {
        flex-direction: row; /* PCã§ã¯æ¨ªã«ä¸¦ã¹ã‚‹ */
        gap: 40px;
      }
    }
    /* ãƒ‘ã‚¿ãƒ¼ãƒ³ä»•æ§˜ä¸€è¦§ã®æ–‡å­—ãŒã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã« */
    .step-section > div[style*="margin-top:10px"] {
      word-break: break-all;
    }
  </style>
</head>
<body>

<h2>L7 äºˆæƒ³ãƒã‚§ã‚¹ç›¤é…ç½®ãƒ„ãƒ¼ãƒ«</h2>

<div class="step-section button-group"> <button onclick="step1()">â‘  35å€‹ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—ç”Ÿæˆ</button>
  <button onclick="resetStorage()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
  <button onclick="downloadInitialCSV()">â‘ çµæœã‚’CSVä¿å­˜</button>
  <div id="step1Container"></div>
  <div id="excludedNumbers"></div>
</div>

<div class="step-section button-group"> <button onclick="step2()">â‘¡ ãƒã‚§ã‚¹ç›¤åˆ†é¡</button>
  <div id="step2Container"></div>
</div>

<div class="step-section button-group"> <button onclick="step3()">â‘¢ ä¸¦ã³æ›¿ãˆï¼ˆç™½â†’1-2è¡Œç›®ã€é»’â†’3-4è¡Œç›®ã€æ®‹ã‚Šâ†’5è¡Œç›®ï¼‰</button>
  <div id="step3Container"></div>
</div>

<div class="step-section button-group"> <button onclick="step4()">â‘£ ãƒ©ãƒ³ãƒ€ãƒ äº¤æ›</button>
  <div id="step4Container"></div>
  <div style="margin-top:10px; font-size:14px; border-top:1px solid #ccc; padding-top:10px;">
    <strong>ãƒ‘ã‚¿ãƒ¼ãƒ³ä»•æ§˜ä¸€è¦§ï¼š</strong><br>
    â‘ ï¼š1â†”4è¡Œç›®ã€2â†”3è¡Œç›®<br>
    â‘¡ï¼š1â†”3è¡Œç›®ã€2â†”4è¡Œç›®<br>
    â‘¢ï¼š1â†”2è¡Œç›®ã€3â†”4è¡Œç›®<br>
    â‘£ï¼š1ã€œ4è¡Œç›®ã¨5è¡Œç›®ã§ãƒ©ãƒ³ãƒ€ãƒ äº¤æ›
  </div>
</div>

<div class="step-section button-group"> <button onclick="step5And6()">â‘¤ å„è¡Œã‚’æ˜‡é †ã«ä¸¦ã³æ›¿ãˆã¦æœ€çµ‚çµæœè¡¨ç¤º & æ¯”è¼ƒè¡¨ç¤º</button>
  <button onclick="downloadComparisonCSV()">æ¯”è¼ƒçµæœã‚’CSVä¿å­˜</button>
  <div id="step5And6Container"></div>
</div>

<script>
  let grid = [];
  let chessColors = [];
  let initialGrid = [];
  let finalGrid = [];
  let excludedNumbers = [];
  const rows = 5;
  const cols = 7;

  function generateUniqueNumbers() {
    let nums = Array.from({ length: 37 }, (_, i) => i + 1);
    for (let i = nums.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [nums[i], nums[j]] = [nums[j], nums[i]];
    }
    const selected = nums.slice(0, 35);
    excludedNumbers = nums.slice(35);
    return selected;
  }

  function step1() {
    const numbers = generateUniqueNumbers();
    grid = [];
    for (let i = 0; i < rows; i++) {
      const row = numbers.slice(i * cols, (i + 1) * cols);
      grid.push(row);
    }

    chessColors = Array.from({ length: rows }, () => Array(cols).fill(''));
    initialGrid = JSON.parse(JSON.stringify(grid));
    document.getElementById('step1Container').innerHTML = '';
    document.getElementById('excludedNumbers').innerHTML = `é¸ã°ã‚Œãªã‹ã£ãŸæ•°å­—: ${excludedNumbers.join(', ')}`;
    renderGrid(grid, null, 'step1Container');
    saveToLocalStorage('step1');
  }

  function step2() {
    chessColors = [];
    for (let r = 0; r < rows; r++) {
      let row = [];
      for (let c = 0; c < cols; c++) {
        row.push((r + c) % 2 === 0 ? 'white' : 'black');
      }
      chessColors.push(row);
    }
    document.getElementById('step2Container').innerHTML = '';
    renderGrid(grid, chessColors, 'step2Container');
    saveToLocalStorage('step2');
  }

  function step3() {
    const whiteOrder = [
      [0, 0], [0, 2], [1, 1], [2, 0], [3, 1], [2, 2], [1, 3],
      [4, 6], [4, 4], [3, 5], [2, 6], [3, 3], [2, 4], [1, 5],
      [4, 0], [4, 2], [0, 4], [0, 6],
    ];

    const blackOrder = [
      [1, 0], [0, 1], [3, 0], [2, 1], [1, 2], [0, 3], [3, 2],
      [4, 5], [3, 6], [4, 3], [3, 4], [2, 5], [1, 6], [0, 5],
      [4, 1], [2, 3], [1, 4],
    ];

    const whiteValues = [], blackValues = [];

    for (let [r, c] of whiteOrder) {
      if (chessColors[r][c] === 'white') whiteValues.push(grid[r][c]);
    }

    for (let [r, c] of blackOrder) {
      if (chessColors[r][c] === 'black') blackValues.push(grid[r][c]);
    }

    const usedWhite = new Set(whiteOrder.map(([r, c]) => `${r},${c}`));
    const usedBlack = new Set(blackOrder.map(([r, c]) => `${r},${c}`));

    const whiteRemainder = [], blackRemainder = [];

    for (let r = 0; r < 5; r++) {
      for (let c = 0; c < 7; c++) {
        const posKey = `${r},${c}`;
        const color = chessColors[r][c];
        if (color === 'white' && !usedWhite.has(posKey)) {
          whiteRemainder.push(grid[r][c]);
        }
        if (color === 'black' && !usedBlack.has(posKey)) {
          blackRemainder.push(grid[r][c]);
        }
      }
    }

    const whiteGroups = [
      whiteValues.slice(0, 7),
      whiteValues.slice(7, 14)
    ];
    const blackGroups = [
      blackValues.slice(0, 7),
      blackValues.slice(7, 14)
    ];
    const remainderGroup = [...whiteValues.slice(14), ...whiteRemainder, ...blackValues.slice(14), ...blackRemainder].slice(0, 7);

    const newGrid = [
      whiteGroups[0],
      whiteGroups[1],
      blackGroups[0],
      blackGroups[1],
      remainderGroup
    ];

    const newColors = newGrid.map((row, i) => {
      if (i < 2) return row.map(() => 'white');
      if (i < 4) return row.map(() => 'black');
      return row.map(() => '');
    });

    grid = newGrid;
    chessColors = newColors;
    document.getElementById('step3Container').innerHTML = '';
    renderGrid(grid, newColors, 'step3Container');
    saveToLocalStorage('step3');
    localStorage.setItem('lotto_step3_grid', JSON.stringify(grid));
    localStorage.setItem('lotto_step3_colors', JSON.stringify(chessColors));
  }

  function step4() {
    const savedStep3Grid = JSON.parse(localStorage.getItem('lotto_step3_grid'));
    const savedStep3Colors = JSON.parse(localStorage.getItem('lotto_step3_colors'));

    if (savedStep3Grid && savedStep3Colors) {
      grid = JSON.parse(JSON.stringify(savedStep3Grid));
      chessColors = JSON.parse(JSON.stringify(savedStep3Colors));
    }
    const swapBetween = (r1, r2) => {
      const count = Math.floor(Math.random() * 4);
      const indices = [...Array(cols).keys()];
        for (let i = indices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [indices[i], indices[j]] = [indices[j], indices[i]];
        }
      for (let i = 0; i < count; i++) {
        const idx = indices[i];
        [grid[r1][idx], grid[r2][idx]] = [grid[r2][idx], grid[r1][idx]];
        [chessColors[r1][idx], chessColors[r2][idx]] = [chessColors[r2][idx], chessColors[r1][idx]];
      }
    };

    const swapAcross = (fromRows, toRow) => {
      const fromPositions = [];
      const toPositions = [];
      fromRows.forEach(r => {
        for (let c = 0; c < cols; c++) {
          fromPositions.push([r, c]);
        }
      });
      for (let c = 0; c < cols; c++) {
        toPositions.push([toRow, c]);
      }

      const swapCount = Math.floor(Math.random() * 4);
      for (let i = 0; i < swapCount; i++) {
        const fromIdx = Math.floor(Math.random() * fromPositions.length);
        const toIdx = Math.floor(Math.random() * toPositions.length);
        const [r1, c1] = fromPositions.splice(fromIdx, 1)[0];
        const [r2, c2] = toPositions.splice(toIdx, 1)[0];
        [grid[r1][c1], grid[r2][c2]] = [grid[r2][c2], grid[r1][c1]];
        [chessColors[r1][c1], chessColors[r2][c2]] = [chessColors[r2][c2], chessColors[r1][c1]];
      }
    };

    const pattern = Math.floor(Math.random() * 4) + 1;
    let patternMessage = '';

    if (pattern === 1) {
      swapBetween(0, 3);
      swapBetween(1, 2);
      patternMessage = 'ãƒ‘ã‚¿ãƒ¼ãƒ³â‘ ã‚’é©ç”¨ï¼š1â†”4è¡Œç›®ã€2â†”3è¡Œç›®ã‚’ãƒ©ãƒ³ãƒ€ãƒ äº¤æ›';
    } else if (pattern === 2) {
      swapBetween(0, 2);
      swapBetween(1, 3);
      patternMessage = 'ãƒ‘ã‚¿ãƒ¼ãƒ³â‘¡ã‚’é©ç”¨ï¼š1â†”3è¡Œç›®ã€2â†”4è¡Œç›®ã‚’ãƒ©ãƒ³ãƒ€ãƒ äº¤æ›';
    } else if (pattern === 3) {
      swapBetween(0, 1);
      swapBetween(2, 3);
      patternMessage = 'ãƒ‘ã‚¿ãƒ¼ãƒ³â‘¢ã‚’é©ç”¨ï¼š1â†”2è¡Œç›®ã€3â†”4è¡Œç›®ã‚’ãƒ©ãƒ³ãƒ€ãƒ äº¤æ›';
    } else if (pattern === 4) {
      swapAcross([0, 1, 2, 3], 4);
      patternMessage = 'ãƒ‘ã‚¿ãƒ¼ãƒ³â‘£ã‚’é©ç”¨ï¼š1ã€œ4è¡Œç›®ã¨5è¡Œç›®ã§ãƒ©ãƒ³ãƒ€ãƒ äº¤æ›';
    }

    document.getElementById('step4Container').innerHTML = `<p style="font-weight:bold;">${patternMessage}</p>`;
    renderGrid(grid, chessColors, 'step4Container');
    saveToLocalStorage('step4');
  }

  function step5And6() {
    finalGrid = grid.map(function(row) { // map ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’ function ã§å®šç¾©
      return Array.from(row).sort(function(a, b) { return a - b; }); // sort ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚‚ function ã§å®šç¾©
    });

    if (!finalGrid.length || !initialGrid.length) {
      alert("â‘ ã¨â‘£ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ã€ã“ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼");
      return;
    }

    const container = document.getElementById('step5And6Container');
    container.innerHTML = '';

    const sortedInitialGrid = initialGrid.map(function(row) { // map ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’ function ã§å®šç¾©
      return Array.from(row).sort(function(a, b) { return a - b; }); // sort ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚‚ function ã§å®šç¾©
    });

    const finalTableHTML = renderTitledGrid("æœ€çµ‚çµæœ", finalGrid);
    const initialTableHTML = renderTitledGrid("ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—çµ„åˆã›ï¼ˆè¡Œã‚’æ˜‡é †ï¼‰", sortedInitialGrid);

    container.insertAdjacentHTML('beforeend', finalTableHTML);
    container.insertAdjacentHTML('beforeend', initialTableHTML);

    saveToLocalStorage('step5');
  }

  function renderGrid(g, colors, containerId) {
    let html = '<table>';
    for (let r = 0; r < g.length; r++) {
      html += '<tr>';
      for (let c = 0; c < g[r].length; c++) {
        const color = colors && colors[r] ? colors[r][c] : ''; // nullish coalescing operator ã®ä»£ã‚ã‚Šã«ä¸‰é …æ¼”ç®—å­ã‚’ä½¿ç”¨
        html += `<td class="${color}">${g[r][c] || ''}</td>`;
      }
      html += '</tr>';
    }
    html += '</table>';
    document.getElementById(containerId).insertAdjacentHTML('beforeend', html);
  }

  function renderTitledGrid(title, gridData) {
    let html = '<div><div style="font-weight:bold; font-size:18px; margin-bottom:5px;">' + title + '</div><table>'; // æ–‡å­—åˆ—çµåˆã‚’+ã«
    for (let r = 0; r < gridData.length; r++) {
      html += '<tr>';
      for (let c = 0; c < gridData[r].length; c++) {
        html += '<td>' + (gridData[r][c] || '') + '</td>'; // æ–‡å­—åˆ—çµåˆã‚’+ã«
      }
      html += '</tr>';
    }
    html += '</table></div>';
    return html;
 }

  function getComparisonCSVContent(gridA, gridB) {
    const maxRows = Math.max(gridA.length, gridB.length);
    const lines = [];

    lines.push("æœ€çµ‚çµæœ1,æœ€çµ‚çµæœ2,æœ€çµ‚çµæœ3,æœ€çµ‚çµæœ4,æœ€çµ‚çµæœ5,æœ€çµ‚çµæœ6,æœ€çµ‚çµæœ7,,ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—1,ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—2,ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—3,ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—4,ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—5,ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—6,ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—7");

    for (let i = 0; i < maxRows; i++) {
      const rowA = gridA[i] || [];
      const rowB = gridB[i] || [];
      // Array.from ã§æ–°ã—ã„é…åˆ—ã‚’ä½œæˆã—ã¦ã‹ã‚‰ slice ã‚’ä½¿ã†
      const paddedA = Array.from(rowA).slice(0, 7);
      while(paddedA.length < 7) paddedA.push(''); // è¶³ã‚Šãªã„åˆ†ã¯ç©ºæ–‡å­—ã§åŸ‹ã‚ã‚‹
      const paddedB = Array.from(rowB).slice(0, 7);
      while(paddedB.length < 7) paddedB.push(''); // è¶³ã‚Šãªã„åˆ†ã¯ç©ºæ–‡å­—ã§åŸ‹ã‚ã‚‹

      lines.push(paddedA.join(',') + ',,' + paddedB.join(',')); // æ–‡å­—åˆ—çµåˆã‚’+ã«
    }

    return lines.join('\n');
  }

  function downloadComparisonCSV() {
    if (!initialGrid.length || !finalGrid.length) {
      alert("â‘ ã¨â‘¤ï¼ˆæœ€çµ‚çµæœè¡¨ç¤º & æ¯”è¼ƒè¡¨ç¤ºï¼‰ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼");
      return;
    }

    const sortedInitialGrid = initialGrid.map(function(row) {
      return Array.from(row).sort(function(a, b) { return a - b; });
    });
    const csvContent = getComparisonCSVContent(finalGrid, sortedInitialGrid);
    const bom = '\uFEFF';
    const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });

    const now = new Date();
    const filename = 'comparison_result_' + now.toISOString().replace(/[:T.]/g, '-') + '.csv'; // ISOstringã§.ã‚‚ç½®ãæ›ãˆ

    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a); // bodyã«è¿½åŠ ã—ãªã„ã¨iOSã§å‹•ã‹ãªã„å ´åˆãŒã‚ã‚‹
    a.click();
    document.body.removeChild(a); // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã«è¦ç´ ã‚’å‰Šé™¤
  }

  function getCSVContent(targetGrid) {
    return targetGrid.map(function(row) { return row.join(','); }).join('\n'); // map ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’ function ã§å®šç¾©
  }

  function downloadInitialCSV() {
    if (!initialGrid.length) {
      alert("â‘ ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„ï¼");
      return;
    }
    const csv = getCSVContent(initialGrid);
    const now = new Date();
    const filename = 'initial_grid_' + now.toISOString().replace(/[:T.]/g, '-') + '.csv'; // ISOstringã§.ã‚‚ç½®ãæ›ãˆ
    triggerCSVDownload(csv, filename);
  }

  function triggerCSVDownload(content, filename) {
    const blob = new Blob([content], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a); // bodyã«è¿½åŠ ã—ãªã„ã¨iOSã§å‹•ã‹ãªã„å ´åˆãŒã‚ã‚‹
    a.click();
    document.body.removeChild(a); // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã«è¦ç´ ã‚’å‰Šé™¤
  }

  function saveToLocalStorage(step) {
    localStorage.setItem('lotto_step', step);
    localStorage.setItem('lotto_grid', JSON.stringify(grid));
    localStorage.setItem('lotto_colors', JSON.stringify(chessColors));
    localStorage.setItem('lotto_initial', JSON.stringify(initialGrid));
    localStorage.setItem('lotto_final', JSON.stringify(finalGrid));
    localStorage.setItem('lotto_excluded_numbers', JSON.stringify(excludedNumbers));
  }

  function loadFromLocalStorage() {
    try {
      const storedGrid = JSON.parse(localStorage.getItem('lotto_grid'));
      const storedColors = JSON.parse(localStorage.getItem('lotto_colors'));
      const storedInitial = JSON.parse(localStorage.getItem('lotto_initial'));
      const storedFinal = JSON.parse(localStorage.getItem('lotto_final'));
      const storedExcludedNumbers = JSON.parse(localStorage.getItem('lotto_excluded_numbers'));
      const step = localStorage.getItem('lotto_step');

      if (storedGrid && storedColors) {
        grid = storedGrid;
        chessColors = storedColors;
        initialGrid = storedInitial || [];
        finalGrid = storedFinal || [];
        excludedNumbers = storedExcludedNumbers || [];

        // ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¯ãƒªã‚¢å‡¦ç†ã‚’æ”¹å–„
        const containers = ['step1Container', 'step2Container', 'step3Container', 'step4Container', 'step5And6Container'];
        for (let i = 0; i < containers.length; i++) {
            document.getElementById(containers[i]).innerHTML = '';
        }
        document.getElementById('excludedNumbers').innerHTML = '';

        // å„ã‚¹ãƒ†ãƒƒãƒ—ã®è¡¨ç¤ºã‚’å†ç¾
        if (step === 'step1') {
            renderGrid(grid, null, 'step1Container');
            document.getElementById('excludedNumbers').innerHTML = 'é¸ã°ã‚Œãªã‹ã£ãŸæ•°å­—: ' + excludedNumbers.join(', ');
        }
        if (step === 'step2') {
            renderGrid(initialGrid, null, 'step1Container');
            document.getElementById('excludedNumbers').innerHTML = 'é¸ã°ã‚Œãªã‹ã£ãŸæ•°å­—: ' + excludedNumbers.join(', ');
            renderGrid(grid, chessColors, 'step2Container');
        }
        if (step === 'step3') {
            renderGrid(initialGrid, null, 'step1Container');
            document.getElementById('excludedNumbers').innerHTML = 'é¸ã°ã‚Œãªã‹ã£ãŸæ•°å­—: ' + excludedNumbers.join(', ');
            renderGrid(grid, chessColors, 'step2Container');
            renderGrid(grid, chessColors, 'step3Container');
        }
        if (step === 'step4') {
            renderGrid(initialGrid, null, 'step1Container');
            document.getElementById('excludedNumbers').innerHTML = 'é¸ã°ã‚Œãªã‹ã£ãŸæ•°å­—: ' + excludedNumbers.join(', ');
            renderGrid(grid, chessColors, 'step2Container');
            renderGrid(grid, chessColors, 'step3Container');
            renderGrid(grid, chessColors, 'step4Container');
        }
        if (step === 'step5') {
            renderGrid(initialGrid, null, 'step1Container');
            document.getElementById('excludedNumbers').innerHTML = 'é¸ã°ã‚Œãªã‹ã£ãŸæ•°å­—: ' + excludedNumbers.join(', ');
            renderGrid(grid, chessColors, 'step2Container');
            renderGrid(grid, chessColors, 'step3Container');
            renderGrid(grid, chessColors, 'step4Container');

            const container = document.getElementById('step5And6Container');
            const sortedInitialGrid = initialGrid.map(function(row) {
              return Array.from(row).sort(function(a, b) { return a - b; });
            });
            const finalTableHTML = renderTitledGrid("æœ€çµ‚çµæœ", finalGrid);
            const initialTableHTML = renderTitledGrid("ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°å­—çµ„åˆã›ï¼ˆè¡Œã‚’æ˜‡é †ï¼‰", sortedInitialGrid);
            container.insertAdjacentHTML('beforeend', finalTableHTML);
            container.insertAdjacentHTML('beforeend', initialTableHTML);
        }
      }
    } catch (e) {
      console.error("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
    }
  }

  function resetStorage() {
    localStorage.clear();
    grid = [];
    chessColors = [];
    initialGrid = [];
    finalGrid = [];
    excludedNumbers = [];
    const containers = ['step1Container', 'step2Container', 'step3Container', 'step4Container', 'step5And6Container'];
    for (let i = 0; i < containers.length; i++) {
        document.getElementById(containers[i]).innerHTML = '';
    }
    document.getElementById('excludedNumbers').innerHTML = '';
  }

  window.onload = function () {
    loadFromLocalStorage();
  };
</script>

</body>
</html>